input {
  # Read from the JSON log file
  file {
    path => "/var/log/app/spring-json.log"
    start_position => "beginning"
    codec => "json"
    tags => ["spring-boot", "elk-stack-poc"]
  }

  # Optional: Read from plain text log file as backup
  file {
    path => "/var/log/app/application.log"
    start_position => "beginning"
    codec => "plain"
    tags => ["spring-boot-plain", "elk-stack-poc"]
  }
}

filter {
  # Parse log level if not already parsed
  if [level] {
    mutate {
      rename => { "level" => "log_level" }
    }
  }

  # Parse message for common patterns
  if [message] {
    # Extract HTTP method, path, status code, and duration
    # Format: "HTTP GET /api/users - Status: 200 - Duration: 45ms"
    grok {
      match => {
        "message" => "HTTP (?<http_method>\w+) (?<http_path>/[\w/.-]*) - Status: (?<http_status>\d{3}) - Duration: (?<response_time>\d+)ms"
      }
      tag_on_failure => []
    }

    # Extract user ID if present (e.g., "user: 123" or "user_id: 123")
    grok {
      match => {
        "message" => "user[_id]*[:\s]+(?<user_id>\d+)"
      }
      tag_on_failure => []
    }

    # Extract order ID if present (e.g., "order: 456")
    grok {
      match => {
        "message" => "order[:\s]+(?<order_id>\d+)"
      }
      tag_on_failure => []
    }

    # Extract email if present
    grok {
      match => {
        "message" => "(?<email>[\w\.-]+@[\w\.-]+)"
      }
      tag_on_failure => []
    }

    # Extract RequestID if present
    grok {
      match => {
        "message" => "RequestID: (?<request_id>REQ-[\w-]+)"
      }
      tag_on_failure => []
    }
  }

  # Parse timestamp
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  } else if [@timestamp] {
    # Elasticsearch default timestamp
  }

  # Add environment information
  mutate {
    add_field => {
      "environment" => "poc"
      "application" => "elk-stack-poc"
      "service_version" => "0.0.1-SNAPSHOT"
    }
  }

  # Convert numeric fields
  mutate {
    convert => {
      "http_status" => "integer"
      "response_time" => "integer"
      "user_id" => "integer"
      "order_id" => "integer"
    }
  }

  # Mark errors for easier visualization
  if [log_level] == "ERROR" or [log_level] == "WARN" {
    mutate {
      add_field => { "is_error" => true }
      add_tag => [ "error_log" ]
    }
  } else {
    mutate {
      add_field => { "is_error" => false }
    }
  }

  # Calculate response time statistics
  if [duration] {
    mutate {
      convert => { "duration" => "float" }
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["host", "path"]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "elk-stack-poc-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Optional: Also output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}

